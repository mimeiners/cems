# LTSpice Simulation of an Idealized Second-Order Sigma-Delta Modulator

In this section, the behavior of an idealized second-order Sigma-Delta (ΔΣ) modulator is demonstrated using an LTSpice simulation. The purpose of this simulation is to validate the fundamental operation of the switched capacitor stages and integrator loops prior to implementing a more realistic circuit.

The model consists of two cascaded switched capacitor integrator stages, followed by a comparator and a digital feedback path. The switched capacitor stages are configured to emulate integrators, where the charge transfer mechanism accurately models the behavior of continuous-time integrators in a discrete-time domain.

The schematic shown in @fig-dsm_l2 represents the complete simulation setup implemented in LTSpice. The primary blocks in this design are:
- **Switched Capacitor Integrators**: Each integrator is implemented using an ideal operational amplifier model and switched capacitors that mimic charge transfer. The capacitors Cs1/Ci1 and Cs2/Ci2 define the integrator characteristics and influence the loop filter coefficients.
- **Clock Phases (Φ₁ and Φ₂)**: Two non-overlapping clock signals control the timing of the switches. These clock signals are generated by voltage sources modeled as pulse generators in LTSpice, ensuring the correct timing and preventing overlap, which is critical to avoid signal corruption.
- **Comparator**: An ideal comparator converts the analog output of the second integrator stage into a digital logic level.
- **Feedback Path**: The output of the comparator is fed back into the modulator, closing the loop. The feedback ensures stability and noise shaping, both characteristic behaviors of ΣΔ modulators.
- **D Flip-Flop**: The comparator output passes through a D Flip-Flop to synchronize the output with the system clock, ensuring stable digital outputs.

![LTSpice Simulation of Second-Order Sigma-Delta Modulator](figures/dsm_l2.png){#fig-dsm_l2 width=100%}  

---

## Key Components and Operation

**Clock Phase Control:**
The simulation uses ideal switches controlled by two non-overlapping clock phases Φ₁ and Φ₂ at a frequency of 220 kHz. These clocks are modeled with pulse generators and are configured to ensure there is no overlap. This guarantees that charge transfer occurs without any unintended charge sharing or signal corruption.

**Switched Capacitor Stages:**
Each switched capacitor stage consists of:
- Sampling capacitors Cs1 and Cs2.
- Integration capacitors Ci1 and Ci2.
- A set of four switches per stage that perform the sampling and integration steps.

The switched capacitor integrators convert the input voltage signal into a charge packet transferred at each clock cycle. This process allows the integrator stages to perform accurate discrete-time integration, critical for the loop filter performance in a ΣΔ modulator.

**Operational Amplifiers:**
The integrators are idealized as operational transconductance amplifiers (OTAs), realized in LTSpice as voltage-controlled current sources. In the ideal model, the OTA provides a linear response across the full input range. In practical designs, care must be taken to ensure that the OTA does not enter saturation, which would otherwise violate the assumptions made in this idealized simulation.

**Comparator and Feedback:**
The second integrator’s output is connected to an ideal comparator. Its digital output is fed back through the feedback path to both integrator stages. This feedback enforces the quantization noise shaping inherent to ΣΔ modulators.

**Simulation Setup:**
The simulation parameters include:
- Power supply voltage VDD = 1.5 V
- Common-mode voltage VCM = 0.75 V
- Input signal: A sine wave with an amplitude of 0.5 V centered at VCM
- Capacitor values:
  - **Cs1 = 1 pF**, **Ci1 = 6 pF**
  - **Cs2 = 1 pF**, **Ci2 = 3 pF**

The transient simulation runs for 30 ms, capturing all relevant node voltages such as vx1, vx2, vq, and vd.

---
This LTSpice simulation demonstrates the core functionality of an idealized second-order Sigma-Delta modulator, including:
- Precise clock phase control to prevent signal corruption.
- Switched capacitor integrator stages emulating discrete-time integration.
- Quantization feedback ensuring noise shaping and high-resolution analog-to-digital conversion.

This model serves as a foundation for developing more realistic circuits, where non-idealities such as switch resistance, parasitic capacitance, and finite OTA gain are considered.

## Output Signals of the First and Second Integrator Stages

Following the LTSpice simulation of the idealized second-order Sigma-Delta modulator, the voltage outputs of the first and second integrator stages were analyzed. These signals provide crucial insight into the operation and dynamic behavior of the modulator’s loop filter.

The voltage waveform V(vx1) represents the output of the first integrator, while V(vx2) corresponds to the output of the second integrator. Both signals are critical in understanding the internal signal processing and how the modulator shapes the quantization noise.

### Integrator 1 Output - V(vx1)

The output of the first integrator, V(vx1), shows the integration of the input signal combined with the feedback from the quantizer. The integrator accumulates charge, resulting in a signal that closely follows the low-frequency components of the input while reacting to the feedback signal to suppress quantization noise within the signal band.

The waveform of V(vx1) demonstrates:
- A smoother signal profile compared to the input, due to its integration function.
- Oscillations introduced by the feedback loop as the system attempts to keep the quantization error shaped and controlled.

### Integrator 2 Output - V(vx2)

The output of the second integrator, V(vx2), exhibits an even higher degree of integration. It represents the second accumulation in the cascade, further enhancing the low-pass filtering effect of the loop filter. This output typically shows:
- A stronger suppression of high-frequency components.
- More pronounced signal swings, as the second integrator amplifies the difference between the first integrator’s output and the feedback signal from the comparator.

The dynamic range of V(vx2) is larger than that of V(vx1), illustrating the additional integration stage’s impact. The output of the second integrator directly feeds into the quantizer (comparator), making its behavior essential to achieving the desired noise shaping properties.

### Output Waveforms Visualization

The time-domain waveforms for both integrator outputs are shown in @fig-Output1_2 below. The x-axis represents the simulation time (0 ms to 30 ms), while the y-axis represents the output voltages of the two integrators. The distinct differences in the signal shapes illustrate the successive integration performed by each stage.

![Integrator Outputs of the Sigma-Delta Modulator](figures/Output1_2.png){#fig-Output1_2 width=60%}

The key observations from these output signals are:
- The first integrator output V(vx1) follows the integrated input and feedback signals, acting as the first stage of the loop filter.

- The second integrator output V(vx2) provides a deeper integration, smoothing out the signal further and preparing it for quantization.

- Both outputs confirm the correct operation of the switched capacitor integrator stages and validate the simulation model.

The correct functioning of these integrators is fundamental to ensuring the modulator shapes quantization noise effectively. In a practical implementation, the design of these integrators would have to consider non-idealities such as finite OTA gain, thermal noise, and parasitic capacitances. However, for this idealized simulation, the results closely match the expected theoretical behavior.

## LTspice OTA representation

In modern analog and mixed-signal circuit design, the OTA plays a critical role, particularly in switched-capacitor integrators and analog filters. Unlike traditional opamps, which act as voltage-controlled voltage sources, OTAs behave as voltage-controlled current sources. The key advantage of an OTA lies in its ability to directly control the output current by varying the input differential voltage, making it well-suited for fully integrated implementations.

An OTA can be modeled in several ways depending on the design stage. Below, we present both a simplified behavioral model used for system-level simulations in LTSpice, and a transistor-level implementation suitable for IC design.



### Behavioral Model of the OTA in LTSpice

For early-stage system verification and discrete-time simulations, a simplified behavioral representation of the OTA can be implemented in LTSpice. This model typically consists of a Voltage-Controlled Current Source (VCCS) combined with an output resistor. The VCCS outputs a current proportional to the difference between the two input voltages (\\(V_{in+} - V_{in-}\\)), while the resistor converts the current into an output voltage.

In this model, the OTA is assumed to operate in its linear region, ensuring that the output current is linearly dependent on the input differential voltage. This linear model is valid as long as the input signal remains within the OTA’s linear input range. If the OTA is driven into saturation, this behavioral model no longer accurately describes its performance.

![LTSpice OTA Behavioral Model](figures/ideal_ota.png){#fig-ideal_ota width=70%}

In the example shown above:
- `Gm` represents the transconductance element of the OTA.  
- `RL` is the load resistor converting current to voltage.  
- The `Vin+` and `Vin-` nodes are the positive and negative differential inputs, respectively.

The transconductance factor (`gm`) determines the gain of the OTA. In the simulation, `G` has a gain of 1000, providing an output current of  
$$
I_{out} = G \cdot (V_{in+} - V_{in-}) \tag{22}
$$

The resistor `RL` converts this current into a voltage drop at the `Out` terminal.



### Transistor-Level of the OTA

For transistor-level design and IC layout, a more accurate model of the OTA is implemented using MOSFETs. The differential pair forms the input stage, converting the input differential voltage into a differential current. Current mirrors and load transistors process this current, providing the desired output characteristics.

The following schematic shows a fully differential OTA structure commonly used in analog integrated circuits:

![Transistor-Level OTA Schematic](figures/ota.png){#fig-Transistor-Level-OTA-Schematic width=70%}

In this circuit:
- The differential pair (`Vin+` and `Vin-`) provides the input transconductance function.  
- The current mirrors at the top and bottom bias and mirror the current for differential operation.  
- The differential outputs `Vout` and `Vinn` allow for fully differential signal processing, improving noise immunity and power supply rejection.

The input differential pair operates in the saturation region, where the drain current  
$$
I_D = \frac{1}{2} \mu C_{ox} \frac{W}{L} (V_{GS} - V_{TH})^2 \tag{23}
$$  
is controlled by the gate-source voltage difference. The output current is mirrored and converted into a differential voltage across the load devices.


### Comparison Between the Models

| **Aspect**                 | **LTSpice Behavioral Model**                    | **Transistor-Level Implementation**         |
|----------------------------|-------------------------------------------------|---------------------------------------------|
| **Complexity**             | Simple and fast for simulation                 | Accurate but complex and slower simulation  |
| **Use Case**               | Circuit-level simulations, functional testing   | Device-level design, IC schematic, performance validation |
| **Nonlinear Effects**      | Ignored (ideal behavior)                      | Fully considered (real-world performance)   |
| **Saturation / Nonlinearity** | Not modeled                                 | Modeled according to device physics         |

By combining both models in the design flow, system functionality can be verified early with the LTSpice behavioral model, while detailed electrical characteristics are analyzed with the transistor-level implementation. The following sections will represent th IC-schematic with xschem.
